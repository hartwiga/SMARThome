<template>
    <div class="page" data-name="cams">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span>Zurück</span>
                    </a>
                </div>
                <div class="title">Außenkameras</div>
                <div class="title-large">
                    <div class="title-large-text">Außenkameras</div>
                </div>
                <div class="right">
                    <a href="#" class="link icon-only photobrowser">
                        <i class="icon f7-icons">camera</i>
                    </a>
                </div>
            </div>
        </div>

        <div class="page-content hide-navbar-on-scroll">
            <div class="card camera">
                <div class="card-content text-align-center vertical-align-middle" style="height: 54vw">
                    <div class="camera-preloader">
                      <div class="preloader" style="width: 44px; height: 44px;"></div>
                  </div>
                    <div class="camera-notavailable">
                        <a>
                            <i class="f7-icons" style="font-size: 36px;color: grey;">arrow_clockwise</i>
                        </a>
                    </div>
                    <img class="camera-stream" src="">
                    <div class="camera-label">Carport [CAM2]</div>
                    <div class="camera-status">
                        <span class="badge color-red hide" data-type="f7" data-class="SSCAM1:Record" data-map-class='{"Start":"", "Stop":"hide"}'></span>
                        <span class="badge color-yellow hide" data-type="f7" data-class="d_get_CAM1" data-map-class='{"capture":"", "off":"hide"}'></span>
                    </div>
                </div>    

                <!--
                <div style="background-image:url({{url}}/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=1&format=mjpeg&_sid={{sid}}),url(./images/iconiOS-180.png)" class="card-header align-items-flex-end">Hauseingang [CAM1]</div>
                -->
                <div class="card-footer">
                    <a data-type="f7" data-object="f7Link" data-device="SSCAM1" data-fhem-cmd-on="set SSCAM1 enable" data-fhem-cmd-off="set SSCAM1 disable" data-map-changed='{"enabled":"on", "disabled":"off"}' data-content="SSCAM1" data-map-content='{"enabled":"AUS","disabled":"EIN"}'></a>
                    <a data-type="f7" data-object="f7Link" data-fhem-cmd="set d_get_CAM1 captured" >FOTO</a>
                    <a data-type="f7" data-object="f7Link" data-device="SSCAM1:Record" data-fhem-cmd-on="set SSCAM1 on" data-fhem-cmd-off="set SSCAM1 off" data-map-changed='{"Start":"on", "Stop":"off"}' data-content="SSCAM1:Record" data-map-content='{"Start":"STOP","Stop":"START"}'></a>
                </div>
            </div>
    
            <div class="card demo-card-header-pic">
                <div style="background-image:url({{url}}/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=2&format=mjpeg&_sid={{sid}})" class="card-header align-items-flex-end">Carport [CAM2]</div>
            </div>

            <div class="card demo-card-header-pic">
                <div style="background-image:url({{url}}/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=3&format=mjpeg&_sid={{sid}})" class="card-header align-items-flex-end">Schuppen [CAM4]</div>
            </div>

            <div class="card demo-card-header-pic">
                <div style="background-image:url({{url}}/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=4&format=mjpeg&_sid={{sid}})" class="card-header align-items-flex-end">Terrasse [CAM5]</div>
            </div>

            <div class="card demo-card-header-pic">
                <div style="background-image:url({{url}}/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=5&format=mjpeg&_sid={{sid}})" class="card-header align-items-flex-end">Garten [CAM6]</div>
            </div>
        </div>
    </div>
</template>
<script>
return {
    data: function() {
        var app = this.$app;
        return {
            token: this.$app.data.token,
            sid: app.data.survialanceStation.sid,
            url: config.surveillancestation.url,
        }
    },
    methods: {

    },
    on: {
        pageInit: function() {
            var $ = this.$;
            var app = this.$app;
            var self = this;
            var router = this.$router;

            //app.preloader.show();
            var cam1url = config.surveillancestation.url + '/webapi/SurveillanceStation/videoStreaming.cgi?api=SYNO.SurveillanceStation.VideoStream&version=1&method=Stream&cameraId=1&format=mjpeg&_sid=' + app.data.survialanceStation.sid;

            var currentImageElement = $$('.camera .camera-stream');
            currentImageElement.attr('src', '');
         
            var imageParentElement = currentImageElement.parent();
            currentImageElement.remove();
            var newImageElement = $$('<img class="camera-stream" src="">')
            imageParentElement.append(newImageElement);
            
            
            newImageElement.on('load', function(e) {
                setTimeout(function () { 
                    $$('.camera .camera-stream').show();
                    $$('.camera .camera-notavailable').hide();
                    $$('.camera .camera-preloader').hide();
                }, 200);
            });
            newImageElement.on('error', function(e) {
                console.log('IMG LOAD ERROR');
                 var src = $$('.camera .camera-stream').attr('src');
                 if(src !== 'none') {
                    $$('.camera .camera-stream').attr('src', 'none');
                 }
                 $$('.camera .camera-notavailable').show();
                 $$('.camera .camera-preloader').hide();
            });
            $$('.camera .camera-notavailable a').on('touchstart mousedown', function(e) {
                console.log('IMG RELOAD');
                $$('.camera .camera-notavailable').hide();
                $$('.camera .camera-preloader').show();
                $$('.camera .camera-stream').attr('src', cam1url);
                e.preventDefault();
            });
            newImageElement.attr('src', cam1url);

            var darkmode = self.$$('html').hasClass('theme-dark') ? true : false;;

            var url = config.surveillancestation.url + '/webapi/entry.cgi'
            var data = {
                api: 'SYNO.SurveillanceStation.SnapShot',
                method: 'List',
                version: 1,
                imgSize: 2,
                limit: 10,
                _sid: app.data.survialanceStation.sid,
            };

            // Get latest snapshots from Synology NAS
            app.request.json(url, data,
                function (data, status, xhr) {             
                    console.log(data);

                    var photos = [];
                    data.data.data.forEach(
                        function (key) {
                            var date = new Date(key.createdTm * 1000);
                            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
                            var photo = {
                                caption: key.camName + ' - ' + date.toLocaleDateString('de-DE', options),
                                url: 'data:image/jpg;base64,' + key.imageData,
                            };

                            photos.push(photo);
                        }
                    );

                    var myPhotoBrowser = app.photoBrowser.create({
                        type: 'page',
                        theme: darkmode ? 'dark' : 'light',
                        pageBackLinkText: 'Zurück',
                        popupCloseLinkText: 'Schließen',
                        navbarOfText: 'bis',
                        photos: photos,
                        on: {
                            opened: function () {
                              console.log('photo browser opened');
                              $$('.navbar-photo-browser a.link.back').removeClass('icon-only');
                              $$('.navbar-photo-browser i.icon-back').removeClass('color-white');
                              //$$('<span>Zurück</span>').insertAfter('.navbar-photo-browser i.icon-back');
                              //$$('.navbar-photo-browser i.icon-back').prepend('<span>Zurück</span>')
                             // $$('<div class="title-large"><div class="title-large-text">Schnapschüsse</div></div>').insertAfter('.navbar-photo-browser .title');

                              $$('a.photo-browser-next i.icon-forward').removeClass('color-white');
                              $$('a.photo-browser-prev i.icon-back').removeClass('color-white');
                            }
                        }
                    });
                    $$('.photobrowser').on('click', function () {
                        myPhotoBrowser.open();
                    });
                    
                },
                function (data, status, xhr) {
                }
            );


            //app.dialog.preloader('Daten werden geladen...');
        },
        pageAfterIn: function(event, page) {
            var $ = this.$;
            var app = this.$app;
            var self = this;
            var router = this.$router;

            //setTimeout(function () { app.preloader.hide()}, 4000);
        },
        pageBeforeOut: function() {
            $$('.camera .camera-stream').attr('src', '');
        }
    },
}
</script>